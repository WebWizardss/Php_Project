;/*FB_PKG_DELIM*/

__d("LSDecryptMessageV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSCreateDerivedKeys.nop","LSGetBlobFromString.nop","LSIsMobileClient","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(g){return c.seq([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessageV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[8]=a[2]==null?c.i64.cast([0,0]):a[2],d[2]=c.i64.of_int32(a[3].length),c.i64.eq(d[2],c.i64.cast([0,1]))?c.seq([function(e){return c.ntop("Array",b("LSArrayGetObjectAt"),a[3],c.i64.cast([0,0])).then(function(a){return a=a,d[12]=a[0],d[13]=a[1],a})},function(e){return d[14]=d[12].get("epoch_anon_id"),d[12],d[15]=d[12].get("epoch_root_key"),d[12],d[16]=c.createArray(),d[26]=(d[16].push(c.i64.cast([0,32])),d[16]),c.i64.ge(d[8],c.i64.cast([0,3]))?c.resolve(d[17]=f):c.seq([function(e){return c.nop(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[17]=d[26]}])},function(e){return c.i64.ge(d[8],c.i64.cast([0,4]))?(d[26]="_",d[18]=["message_key_in_epoch",d[26],c.blobs.to_string(d[14]),d[26],"cipher_version",d[26],c.i64.to_string(d[8]),d[26],"thread",d[26],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,3]))?(d[27]="_",d[26]=["message_key_in_epoch",d[27],c.blobs.to_string(d[14]),d[27],"cipher_version",d[27],c.i64.to_string(d[8]),d[27],"thread",d[27],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,2]))?(d[28]="_",d[27]=["message_key_in_epoch",d[28],c.blobs.to_string(d[14]),d[28],"cipher_version",d[28],c.i64.to_string(d[8])].join("")):d[27]=["message_key_in_epoch","_",c.blobs.to_string(d[14])].join(""),d[26]=d[27]),d[18]=d[26]),c.nop(b("LSGetBlobFromString.nop"),d[18]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nop(b("LSCreateDerivedKeys.nop"),d[19],d[17],d[15],d[16]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!1:d[21]=!0,d[21]?c.resolve(d[22]=f):c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[20],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return d[22]=d[26]}])},function(e){return c.blobs.neq(d[22],f)?c.seq([function(e){return c.nop(b("LSSymmetricEncryptionCreateDecryptedString.nop"),d[22],c.blobs.of_string(["message_thread","_",a[1]].join("")),a[0]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[26]!==f?c.resolve(d[27]=d[26]):c.seq([function(a){return d[28]=["Failed to decrypt message. Epoch Anon ID: ",c.blobs.to_string(d[14]),", Encryption Version: ",c.i64.to_string(d[8])].join(""),function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] ","",d[28]].join("")),d[29]=c.createArray(),f!==f?d[30]=(d[29].push(f),d[29]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure",[d[28]].join(""),d[29],c.i64.cast([0,3]))},function(a){return d[27]=f}])},function(a){return d[23]=d[27]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null"),f!==f?c.seq([function(a){return f!==f?c.sp(b("LSAppendDataTraceAddon"),f,c.i64.cast([0,85]),c.i64.cast([0,2]),"[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null",f):c.resolve()},function(a){return c.sp(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),f!==f?d[30]=(d[29].push(f),d[29]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[26]=c.createArray(),f!==f?d[27]=(d[26].push(f),d[26]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure","Decryption message key is null",d[26],c.i64.cast([0,3]))},function(a){return d[23]=f}])},function(a){return d[23]!==f?(a=[d[23],f],d[24]=a[0],d[25]=a[1],a):(d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,101])),d[26].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[26].set("error_message",""),a=[f,d[26]],d[24]=a[0],d[25]=a[1],a),a=[d[24],d[25]],d[3]=a[0],d[4]=a[1],a}]):c.resolve((d[12]=c.i64.of_int32(a[3].length),c.i64.eq(d[12],c.i64.cast([0,0]))?(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,102])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[f,d[15]],d[13]=e[0],d[14]=e[1],e):(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,103])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[f,d[15]],d[13]=e[0],d[14]=e[1],e),e=[d[13],d[14]],d[3]=e[0],d[4]=e[1],e))},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[11]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessageV2] ",d[7],d[9],d[7],d[10],d[7],d[11]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),f!==f?d[14]=(d[13].push(f),d[13]):0,c.nop(b("LSLogMebClientEvent.nop"),"decryptMessageV2",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[3],d[4]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}c=a;f["default"]=c}),66);
__d("LSDecryptMessages",["LSArrayGetObjectAt","LSBase64Decode.nop","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSDecryptMessageV2","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(g){return c.seq([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessages] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.ftr(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,h){var i=e.done;e=e.value;return i?(d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,1])),d[11].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[11].set("error_message",""),i=[f,d[11]],d[2]=i[0],d[3]=i[1],i):(h=e.item,c.seq([function(a){return d[18]=h.backupId,d[17]=h.backupTenancy,d[16]=h.encryptionVersion,c.i64.neq(f,f)?c.resolve(d[11]=f):c.seq([function(a){return d[19]=c.createArray(),c.sp(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[29]=(d[19].push(c.i64.cast([0,0])),d[19]):0,c.sp(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[29]=(d[19].push(c.i64.cast([0,2])),d[19]):0,c.sp(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[22]=a[0],a})},function(a){return d[22]?d[29]=(d[19].push(c.i64.cast([0,3])),d[19]):0,c.sp(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[23]?d[29]=(d[19].push(c.i64.cast([0,4])),d[19]):0,d[24]=c.createArray(),d[25]=c.i64.of_int32(d[19].length),c.i64.gt(d[25],c.i64.cast([0,0]))?c.loopAsync(d[25],function(a){return d[29]=a,c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[19],d[29]).then(function(a){return a=a,d[30]=a[0],d[31]=a[1],a})},function(a){return d[32]=(d[24].push(d[30]),d[24])}])}):c.resolve()},function(a){return c.seq([function(a){return d[29]=c.createArray(),d[30]=c.i64.of_int32(d[24].length),c.i64.gt(d[30],c.i64.cast([0,0]))?c.loopAsync(d[30],function(a){return d[32]=a,c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[24],d[32]).then(function(a){return a=a,d[33]=a[0],d[34]=a[1],a})},function(a){return d[35]=(d[29].push(c.i64.to_string(d[33])),d[29])}])}):c.resolve()},function(a){return d[31]=d[29].join(","),d[26]=d[31]}])},function(a){return d[24].some(function(a){return c.i64.eq(d[16],a)})?d[27]=d[16]:d[27]=f,c.i64.neq(d[27],f)?d[28]=d[27]:d[28]=f,d[11]=d[28]}])},function(e){return c.i64.neq(d[11],f)?d[12]=d[11]:d[12]=c.i64.cast([0,0]),c.i64.neq(d[17],f)?d[13]=d[17]:d[13]=c.i64.cast([0,1]),c.i64.neq(h.deviceId,f)?c.seq([function(e){return d[19]=c.createArray(),d[20]=c.createArray(),d[21]=new c.Map(),d[22]=c.i64.of_int32(a[0].length),c.i64.gt(d[22],c.i64.cast([0,0]))?c.loopAsync(d[22],function(e){return d[26]=e,c.seq([function(e){return c.ntop("Array",b("LSArrayGetObjectAt"),a[0],d[26]).then(function(a){return a=a,d[27]=a[0],d[28]=a[1],a})},function(a){return d[29]=d[27].get("epoch_anon_id"),d[27],d[30]=d[21].get(c.blobs.to_string(d[29])),d[21],d[30]!==f?c.resolve(d[31]=d[30]):c.seq([function(a){return d[36]=d[27].get("epoch_anon_id"),d[27],d[37]=d[27].get("epoch_id"),d[27],c.i64.neq(d[37],f)?c.seq([function(a){return d[42]=c.createArray(),c.fe(c.ftr(c.db.table(169).fetch([[[d[37]]]]),function(a){return c.i64.eq(a.backupId,d[18])&&c.i64.eq(a.epochId,d[37])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[38]=d[42]}]):c.seq([function(a){return d[42]=c.createArray(),c.fe(c.ftr(c.db.table(169).fetch([[[d[18]]],"fk_secure_encrypted_backups_client_state"]),function(a){return c.i64.eq(a.backupId,d[18])&&c.blobs.eq(a.epochAnonIdBlob,d[36])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[38]=d[42]}])},function(a){return d[39]=c.i64.of_int32(d[38].length),c.i64.gt(d[39],c.i64.cast([0,0]))?c.resolve(d[40]=d[38]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] No epoch found. Attempting to decrypt with fallback key."),d[42]=c.createArray(),f!==f?d[55]=(d[42].push(f),d[42]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","No epoch found. Attempting to decrypt with fallback key.",d[42],c.i64.cast([0,3]))},function(a){return d[43]=d[27].get("fallback_encrypted_epoch_key"),d[27],c.blobs.neq(d[43],f)?c.seq([function(a){return c.ftr(c.db.table(169).fetch(),function(a){return c.blobs.eq(a.epochAnonIdBlob,c.blob("MA=="))}).next().then(function(e,j){var a=e.done;e=e.value;return a?c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTableUtils] Failed to get mailbox_root_key_v2: epoch 0 is not available."),d[59]=c.createArray(),f!==f?d[60]=(d[59].push(f),d[59]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBTableUtils","Failed to get mailbox_root_key_v2: epoch 0 is not available.",d[59],c.i64.cast([0,3]))},function(a){return d[55]=f}]):(j=e.item,c.seq([function(a){return d[59]=c.createArray(),d[67]=(d[59].push(c.i64.cast([0,32])),d[59]),c.nop(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleT5zYWx0X21haWxib3hfcm9vdF9rZXlfdjI="),f,h.mailboxRootKeyBlob,d[59]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return d[60]!==f?c.seq([function(a){return d[67]=c.i64.of_int32(d[60].length),c.i64.ge(d[67],c.i64.cast([0,1]))?c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[60],c.i64.cast([0,0])).then(function(a){return a=a,d[69]=a[0],d[70]=a[1],a})},function(a){return d[68]=d[69]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[69]=c.createArray(),f!==f?d[70]=(d[69].push(f),d[69]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[69],c.i64.cast([0,3]))},function(a){return d[68]=f}])},function(a){return d[61]=d[68]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[67]=c.createArray(),f!==f?d[68]=(d[67].push(f),d[67]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[67],c.i64.cast([0,3]))},function(a){return d[61]=f}])},function(a){return c.blobs.neq(d[61],f)?d[62]=!0:d[62]=!1,d[62]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d[63]=c.createArray(),d[67]=(d[63].push(c.i64.cast([0,32])),d[63]),c.nop(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleT5tYWlsYm94X3Jvb3Rfa2V5X3Yy"),d[61],j.epochRootKeyBlob,d[63]).then(function(a){return a=a,d[64]=a[0],a})},function(a){return d[64]!==f?c.seq([function(a){return d[67]=c.i64.of_int32(d[64].length),c.i64.ge(d[67],c.i64.cast([0,1]))?c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[64],c.i64.cast([0,0])).then(function(a){return a=a,d[69]=a[0],d[70]=a[1],a})},function(a){return d[68]=d[69]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[69]=c.createArray(),f!==f?d[70]=(d[69].push(f),d[69]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[69],c.i64.cast([0,3]))},function(a){return d[68]=f}])},function(a){return d[65]=d[68]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[67]=c.createArray(),f!==f?d[68]=(d[67].push(f),d[67]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[67],c.i64.cast([0,3]))},function(a){return d[65]=f}])},function(a){return c.blobs.neq(d[65],f)?d[66]=!0:d[66]=!1,d[66]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d[55]=d[65]}]))})},function(a){return c.blobs.neq(d[55],f)?c.seq([function(a){return d[59]=c.createArray(),d[63]=(d[59].push(c.i64.cast([0,32])),d[59]),c.nop(b("LSCreateDerivedKeys.nop"),c.blob("a2RmX2luZm86bWFpbGJveF9yb290X2tleV92Mj5mYWxsYmFja19rZXk="),f,d[55],d[59]).then(function(a){return a=a,d[60]=a[0],a})},function(a){return d[60]!==f?c.seq([function(a){return d[63]=c.i64.of_int32(d[60].length),c.i64.ge(d[63],c.i64.cast([0,1]))?c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[60],c.i64.cast([0,0])).then(function(a){return a=a,d[65]=a[0],d[66]=a[1],a})},function(a){return d[64]=d[65]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[65]=c.createArray(),f!==f?d[66]=(d[65].push(f),d[65]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[65],c.i64.cast([0,3]))},function(a){return d[64]=f}])},function(a){return d[61]=d[64]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[63]=c.createArray(),f!==f?d[64]=(d[63].push(f),d[63]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[63],c.i64.cast([0,3]))},function(a){return d[61]=f}])},function(a){return c.blobs.neq(d[61],f)?d[62]=!0:d[62]=!1,d[62]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),d[57]=d[61]}]):c.resolve(d[57]=f)},function(a){return c.blobs.neq(d[57],f)?c.seq([function(a){return c.nop(b("LSBase64Encode.nop"),d[43]).then(function(a){return a=a,d[59]=a[0],a})},function(a){return d[59]!==f?c.seq([function(a){return c.nop(b("LSSymmetricEncryptionCreateDecryptedString.nop"),d[57],c.blob("ZmFsbGJhY2tfZW5jcnlwdGVkX2Vwb2NoX2tleQ=="),d[59]).then(function(a){return a=a,d[62]=a[0],a})},function(a){return c.nop(b("LSBase64Decode.nop"),d[62]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return d[60]=d[63]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoUtils] Failed to base64-encode fallback key ciphertext. This should really never happen."),d[62]=c.createArray(),f!==f?d[63]=(d[62].push(f),d[62]):0,c.nop(b("LSLogMebClientEvent.nop"),"MEBCryptoUtils","Failed to base64-encode fallback key ciphertext. This should really never happen.",d[62],c.i64.cast([0,3]))},function(a){return d[60]=f}])},function(a){return c.blobs.neq(d[60],f)?c.resolve((d[62]=d[27].get("epoch_anon_id"),d[27],d[63]=new c.Map(),d[63].set("epoch_anon_id",d[62]),d[63].set("epoch_root_key",d[60]),d[64]=c.createArray(),d[65]=(d[64].push(d[63]),d[64]),d[61]=d[64])):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] Failed to decrypt fallback encrypted epoch key."),d[62]=c.createArray(),f!==f?d[64]=(d[62].push(f),d[62]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","Failed to decrypt fallback encrypted epoch key.",d[62],c.i64.cast([0,3]))},function(a){return d[63]=c.createArray(),d[61]=d[63]}])},function(a){return d[58]=d[61]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] Failed to get fallback key."),d[59]=c.createArray(),f!==f?d[61]=(d[59].push(f),d[59]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","Failed to get fallback key.",d[59],c.i64.cast([0,3]))},function(a){return d[60]=c.createArray(),d[58]=d[60]}])},function(a){return d[44]=d[58]}]):c.seq([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] Encrypted message has no fallback encrypted epoch key."),d[55]=c.createArray(),f!==f?d[57]=(d[55].push(f),d[55]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure","Encrypted message has no fallback encrypted epoch key.",d[55],c.i64.cast([0,3]))},function(a){return d[56]=c.createArray(),d[44]=d[56]}])},function(a){return d[48]="Epoch not found. Attempting to decrypt using fallback key.",d[49]="epoch_anon_id=",d[45]=d[27].get("epoch_anon_id"),d[27],d[51]=c.blobs.to_string(d[45]),d[52]=" decrypted_fallback_key_count=",d[46]=c.i64.of_int32(d[44].length),d[53]=c.i64.to_string(d[46]),d[47]="",function(a){c.logger(a).warn(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptMessagesStoredProcedure] ",d[47],d[48],d[47],d[49],d[47],d[51],d[47],d[52],d[47],d[53]].join("")),d[50]=",",d[54]=c.createArray(),f!==f?d[55]=(d[54].push(f),d[54]):0,c.nop(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessagesStoredProcedure",[d[48],d[50],d[49],d[50],d[51],d[50],d[52],d[50],d[53]].join(""),d[54],c.i64.cast([0,2]))},function(a){return d[40]=d[44]}])},function(a){return d[41]=c.i64.of_int32(d[40].length),c.i64.gt(d[41],c.i64.cast([0,0]))?(d[42]=d[27].get("epoch_anon_id"),d[27],d[21].set(c.blobs.to_string(d[42]),d[40])):0,d[31]=d[40]}])},function(e){return d[32]=d[27].get("value"),d[27],d[33]=d[27].get("encryption_version"),d[27],c.sp(b("LSDecryptMessageV2"),d[32],a[1],d[33],d[31]).then(function(a){return a=a,d[34]=a[0],d[35]=a[1],a})},function(a){return d[34]!==f?(d[36]=d[27].get("otid"),d[27],d[37]=new c.Map(),d[37].set("value",d[34]),d[37].set("otid",d[36]),d[38]=(d[19].push(d[37]),d[19])):(d[35]!==f?(d[36]=d[27].get("otid"),d[27],d[37]=d[27].get("epoch_anon_id"),d[27],d[38]=d[27].get("encryption_version"),d[27],c.i64.neq(d[38],f)?d[39]=c.i64.to_string(d[38]):d[39]="null",d[40]=c.i64.of_int32(d[31].length),d[41]="",d[35].set("error_message",["Decryption failed for message ",d[41],d[36],d[41]," epoch:",d[41],c.blobs.to_string(d[37]),d[41]," version:",d[41],d[39],d[41]," epoch_key_count:",d[41],c.i64.to_string(d[40])].join(""))):0,d[36]=(d[20].push(d[35]),d[20]))}])}):c.resolve()},function(a){return d[23]=c.i64.of_int32(d[20].length),c.i64.gt(d[23],c.i64.cast([0,0]))?c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[20],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return a=[f,d[26]],d[24]=a[0],d[25]=a[1],a}]):c.resolve((a=[d[19],f],d[24]=a[0],d[25]=a[1],a))},function(a){return a=[d[24],d[25]],d[14]=a[0],d[15]=a[1],a}]):c.resolve((d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,1])),d[19].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[19].set("error_message",""),e=[f,d[19]],d[14]=e[0],d[15]=e[1],e))},function(a){return a=[d[14],d[15]],d[2]=a[0],d[3]=a[1],a}]))})},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessages] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),f!==f?d[13]=(d[12].push(f),d[12]):0,c.nop(b("LSLogMebClientEvent.nop"),"decryptMessages",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}c=a;f["default"]=c}),66);
__d("LSRestoreEchoBlobs",["LSIntEnum","MAWRestoreMessagesFromEncryptedBackupsDeferred","Promise","WALogger","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSRestoreEchoBlobs error: ",""]);j=function(){return a};return a}function a(a,e,f,g,k,l,m,n,o,p,q,r,s){c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call(a,"AdvancedCrypto",p,g,k,l,m,n,o,q,r,s!=null?(i||(i=d("LSIntEnum"))).unwrapIntEnum(s):-1)["catch"](function(a){d("WALogger").ERROR(j(),a);return(h||(h=b("Promise"))).resolve([[],[],!0])}));return(h||(h=b("Promise"))).resolve([[],[],!0])}e=a;g.call=e}),98);
__d("LSRestoreEchoBlobs.nop",["LSRestoreEchoBlobs"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c,e,f,g,h,i,j,k,l,m,n){return d("LSRestoreEchoBlobs").call(a,b,c,e,f,g,h,i,j,k,l,m,n)};g["default"]=a}),98);
__d("LSHandleMessageRestoreResponse",["LSArrayGetObjectAt","LSDecryptMessages","LSDeleteBackupOnClient","LSIssueNewTask","LSIssuePointQueryRestoreTask","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSRestoreEchoBlobs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(e){return c.seq([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageRestoreResponse] Beginning execution."),d[1]=c.i64.of_float(Date.now()),a[7]?(d[9]="handleMessageRestoreResponse was called with instructions to delete the user's EB client state",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[9]].join("")),d[10]=c.createArray(),f!==f?d[11]=(d[10].push(f),d[10]):0,c.nop(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[9]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()},function(b){return c.i64.neq(a[6],f)?c.seq([function(b){return c.ftr(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var g=b.done;b=b.value;return g?d[9]=!1:(e=b.item,d[12]=e.deviceId,c.i64.neq(d[12],f)?d[11]=c.i64.neq(d[12],a[6]):d[11]=!1,d[9]=d[11])})},function(a){return d[2]=d[9]}]):c.resolve(d[2]=!1)},function(e){return d[2]?(d[9]="Exiting early due to EBDevice ID mismatch",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[9]].join("")),d[10]=c.createArray(),f!==f?d[11]=(d[10].push(f),d[10]):0,c.nop(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[9]].join(""),d[10],c.i64.cast([0,4]))):c.seq([function(b){return d[9]=a[5].get("reference_timestamp"),a[5],d[10]=a[5].get("request_id"),a[5],d[11]=a[5].get("restore_task_source"),a[5],c.i64.neq(a[6],f)?c.seq([function(b){return c.ftr(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var g=b.done;b=b.value;return g?d[18]=!1:(e=b.item,d[21]=e.deviceId,c.i64.neq(d[21],f)?d[20]=c.i64.neq(d[21],a[6]):d[20]=!1,d[18]=d[20])})},function(a){return d[12]=d[18]}]):c.resolve(d[12]=!1)},function(e){return d[12]?c.resolve((d[18]=new c.Map(),d[18].set("error_code",c.i64.cast([0,110])),d[18].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[18].set("error_message",""),d[13]=d[18])):c.seq([function(e){return c.sp(b("LSDecryptMessages"),a[0],a[2]).then(function(a){return a=a,d[18]=a[0],d[19]=a[1],a})},function(e){return d[18]!==f?c.seq([function(e){return c.sp(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(e){return c.i64.neq(d[21],f)?c.seq([function(e){return f!==f?c.resolve(d[24]=f):c.seq([function(a){return d[25]=c.createArray(),d[26]=c.i64.of_int32(d[18].length),c.i64.gt(d[26],c.i64.cast([0,0]))?c.loopAsync(d[26],function(a){return d[35]=a,c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[18],d[35]).then(function(a){return a=a,d[36]=a[0],d[37]=a[1],a})},function(a){return d[38]=d[36].get("value"),d[36],d[39]=(d[25].push(d[38]),d[25])}])}):c.resolve()},function(e){return d[27]=a[1].get("has_more_before"),a[1],d[28]=a[1].get("next_message_timestamp_ms_before"),a[1],d[29]=a[1].get("has_more_after"),a[1],d[30]=a[1].get("next_message_timestamp_ms_after"),a[1],c.nop(b("LSRestoreEchoBlobs.nop"),d[21],d[25],d[27],d[28],d[29],d[30],a[4],a[2],d[10],d[9],d[11]).then(function(a){return a=a,d[31]=a[0],d[32]=a[1],d[33]=a[2],a})},function(e){return a[7]?c.sp(b("LSDeleteBackupOnClient"),f,f,!0,d[10],f,!0):c.resolve()},function(e){return d[31]?c.seq([function(e){return d[35]=c.i64.of_int32(d[33].length),d[36]=c.i64.of_int32(d[32].length),c.i64.eq(d[36],d[35])?c.seq([function(e){return d[38]=c.i64.cast([0,0]),d[39]=c.i64.of_int32(d[33].length),c.i64.gt(d[39],c.i64.cast([0,0]))?c.loopAsync(d[39],function(e){return d[40]=e,c.seq([function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[33],d[40]).then(function(a){return a=a,d[41]=a[0],d[42]=a[1],a})},function(a){return c.ntop("Array",b("LSArrayGetObjectAt"),d[32],d[38]).then(function(a){return a=a,d[43]=a[0],d[44]=a[1],a})},function(e){return c.sp(b("LSIssuePointQueryRestoreTask"),a[2],d[43],d[41],f,c.i64.cast([0,35])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[38]=c.i64.add(d[38],c.i64.cast([0,1]))}])}):c.resolve()},function(a){return d[37]=f}]):c.resolve((d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,106])),d[38].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[38].set("error_message",""),d[37]=d[38]))},function(a){return d[34]=f}]):c.resolve((d[35]=new c.Map(),d[35].set("error_code",c.i64.cast([0,105])),d[35].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[35].set("error_message",""),d[34]=d[35]))},function(a){return d[24]=d[34]}])},function(a){return d[23]=d[24]}]):c.resolve(d[23]=d[22])},function(a){return d[20]=d[23]}]):c.resolve(d[20]=d[19])},function(a){return d[13]=d[20]}])},function(e){return d[13]!==f?c.seq([function(e){return a[7]?c.sp(b("LSDeleteBackupOnClient"),f,f,!0,d[10],f,!0):c.resolve()},function(e){return d[18]=d[13].get("error_code"),d[13],d[19]=d[13].get("stored_procedure"),d[13],d[20]=a[5].get("restore_operation_type"),a[5],d[21]=new c.Map(),d[21].set("error_code",d[18]),d[21].set("error_message",""),d[21].set("stored_procedure",d[19]),d[22]=new c.Map(),d[22].set("act_thread_id",a[2]),d[22].set("source",d[11]),d[22].set("restore_operation_type",d[20]),d[23]=new c.Map(),d[23].set("restore_context",d[22]),d[23].set("failure",d[21]),d[24]=d[23].get("restore_context"),d[23],d[25]=d[24].get("act_thread_id"),d[24],d[26]=c.toJSON(d[23]),c.sp(b("LSIssueNewTask"),["encrypted_backups_restore",":",d[25]].join(""),c.i64.cast([0,50030]),d[26],f,f,c.i64.cast([0,0]),c.i64.cast([0,0]),f,f,c.i64.cast([0,0]),c.i64.cast([0,0]))},function(b){return d[27]=a[5].get("restore_operation_type"),a[5],d[28]=d[13].get("error_code"),d[13],d[29]=d[13].get("error_code"),d[13],d[30]=" ",d[14]=["Failed (",d[30],c.i64.to_string(d[29]),d[30],")"].join("")}]):c.resolve((d[18]=a[5].get("restore_operation_type"),a[5],d[14]="Succeeded"))},function(e){return d[15]="",d[16]=["Message Restore Status: ",d[15],d[14],d[15],". ACT Thread ID: ",d[15],a[2]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[16]].join("")),d[17]=c.createArray(),f!==f?d[18]=(d[17].push(f),d[17]):0,c.nop(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[16]].join(""),d[17],c.i64.cast([0,4]))}])},function(a){return d[3]=c.i64.of_float(Date.now()),d[4]=c.i64.random(),d[6]="Finishing execution. Execution time: ",d[7]=c.i64.to_string(c.i64.sub(d[3],d[0])),d[8]=" ms",d[5]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ",d[5],d[6],d[5],d[7],d[5],d[8]].join("")),c.i64.eq(c.i64.mod_(d[4],c.i64.cast([0,100])),c.i64.cast([0,0]))?(d[9]=",",d[10]=c.createArray(),f!==f?d[11]=(d[10].push(f),d[10]):0,c.nop(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[6],d[9],d[7],d[9],d[8]].join(""),d[10],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}c=a;f["default"]=c}),66);/*FB_PKG_DELIM*/
__d("LSUpdateOptimisticContextThreadKeys",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.seq([function(c){return b.seq([function(c){return b.fe(b.ftr(b.db.table(32).fetch(),function(c){return b.i64.eq(c.threadKey,a[0])}),function(b){var c=b.update;b.item;return c({threadKey:a[1]})})},function(c){return b.fe(b.ftr(b.db.table(31).fetch(),function(c){return b.i64.eq(c.threadKey,a[0])}),function(b){var c=b.update;b.item;return c({threadKey:a[1]})})}])},function(a){return b.resolve(c)}])}b=a;f["default"]=b}),66);
__d("LSUpdateTaskQueueName",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.seq([function(c){return b.fe(b.db.table(2).fetch([[[a[0]]],"queueNameTaskId"]),function(b){var c=b.update;b.item;return c({queueName:a[1]})})},function(a){return b.resolve(c)}])}b=a;f["default"]=b}),66);
__d("LSUpdateTaskValue",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.seq([function(c){return b.fe(b.db.table(2).fetch([[[a[0]]],"queueNameTaskId"]),function(b){var c=b.update;b=b.item;return c({taskValue:b.taskValue.split(a[1]).join(a[2])})})},function(a){return b.resolve(c)}])}b=a;f["default"]=b}),66);
__d("LSShimHybridThreadDeleteUtil",["Promise","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.table("mi_act_mapping_table")).getKeyRange(b)).then(function(a){return a})}function c(a,c){if(c!=null)return(h||(h=b("Promise"))).all([a.table("threads")["delete"](c.serverThreadKey),a.table("mi_act_mapping_table")["delete"](c.serverThreadKey,c.clientThreadPk,c.jid)]).then(function(){});else return(h||(h=b("Promise"))).resolve()}g.getMiActMappingRow=a;g.deleteE2EEMetadataTable=c}),98);
__d("LSShimHybridThreadDeleteByThreadKey.bs",["LSShimHybridThreadDeleteUtil"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("LSShimHybridThreadDeleteUtil").getMiActMappingRow(a,c).then(function(b){return d("LSShimHybridThreadDeleteUtil").deleteE2EEMetadataTable(a,b)}).then(function(){})}g.call=a}),98);
__d("LSShimHybridThreadDeleteByThreadKey.nop",["LSShimHybridThreadDeleteByThreadKey.bs"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c){return d("LSShimHybridThreadDeleteByThreadKey.bs").call(a,b,c)};g["default"]=a}),98);
__d("LSHybridThreadDelete",["LSShimHybridThreadDeleteByThreadKey.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[];return c.seq([function(d){return c.nop(b("LSShimHybridThreadDeleteByThreadKey.nop"),a[0])},function(a){return c.resolve(d)}])}c=a;f["default"]=c}),66);
__d("LSTransportHybridParticipantUpdateReceipts",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.resolve(c)}b=a;f["default"]=b}),66);
__d("LSReplaceOptimisticThread",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.seq([function(c){return b.db.table(9).fetch([[[a[1]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?b.fe(b.ftr(b.db.table(9).fetch([[[a[0]]]]),function(c){return b.i64.eq(c.threadKey,a[0])&&b.i64.le(c.authorityLevel,b.i64.cast([0,20]))}),function(c){var d=c.update;c.item;return d({threadKey:a[1],authorityLevel:b.i64.cast([0,40])})}):(c.item,b.fe(b.db.table(9).fetch([[[a[0]]]]),function(a){return a["delete"]()}))})},function(a){return b.resolve(c)}])}b=a;f["default"]=b}),66);
__d("LSShimGetServerThreadKeyFromJIDV2.bs",["Promise","ReQL","RetUtil"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,c,e){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.table("mi_act_mapping_table").index("jid")).getKeyRange(e)).then(function(a){return a!=null?(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult(a.serverThreadKey)):(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult())})}g.call=a}),98);
__d("LSShimGetServerThreadKeyFromJIDV2.nop",["LSShimGetServerThreadKeyFromJIDV2.bs"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c){return d("LSShimGetServerThreadKeyFromJIDV2.bs").call(a,b,c)};g["default"]=a}),98);
__d("LSUpdateThreadAuthorityAndMapping",["LSDeleteThread","LSReplaceOptimisticThread","LSShimGetServerThreadKeyFromJIDV2.nop","LSUpdateOptimisticContextThreadKeys","LSUpdateTaskQueueName","LSUpdateTaskValue"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(e){return c.seq([function(e){return c.nop(b("LSShimGetServerThreadKeyFromJIDV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(b){return c.db.table(9).fetch([[[a[1]]]]).next().then(function(a,b){b=a.done;a=a.value;return b?d[1]=!1:(a.item,d[1]=!0)})},function(b){return c.ftr(c.db.table(9).fetch(),function(b){return c.i64.eq(b.threadKey,a[2])}).next().then(function(a,b){b=a.done;a=a.value;return b?d[3]=!1:(a.item,d[3]=!0)})},function(e){return d[5]=c.i64.neq(d[0],f),d[7]=c.i64.eq(d[0],a[2])&&d[5],!d[7]&&!(c.i64.eq(d[0],a[1])&&d[5])&&d[5]?function(a){c.logger(a).mustfix(a)}("The mi_act_mapping row did not correspond to either the authoritative or optimistic thread key."):0,c.i64.neq(a[2],f)?d[6]=a[2]:d[6]=c.i64.cast([0,0]),d[5]?d[7]?c.seq([function(e){return d[1]?c.sp(b("LSDeleteThread"),a[1],!1):c.resolve()},function(a){return c.i64.neq(d[6],f)?c.fe(c.db.table(9).fetch([[[d[6]]]]),function(a){var b=a.update;a.item;return b({clientThreadKey:d[6]})}):c.resolve()},function(e){return c.sp(b("LSReplaceOptimisticThread"),d[6],a[1])},function(e){return c.sp(b("LSUpdateOptimisticContextThreadKeys"),d[6],a[1])}]):d[3]?c.sp(b("LSDeleteThread"),d[6],!1):c.resolve():d[3]?d[1]?c.sp(b("LSDeleteThread"),d[6],!1):c.seq([function(a){return c.i64.neq(d[6],f)?c.fe(c.db.table(9).fetch([[[d[6]]]]),function(a){var b=a.update;a.item;return b({clientThreadKey:d[6]})}):c.resolve()},function(e){return c.sp(b("LSReplaceOptimisticThread"),d[6],a[1])},function(e){return c.sp(b("LSUpdateOptimisticContextThreadKeys"),d[6],a[1])}]):c.resolve()},function(e){return d[3]?c.seq([function(e){return d[9]=c.i64.to_string(d[6]),d[8]=c.i64.to_string(a[1]),c.sp(b("LSUpdateTaskQueueName"),d[9],d[8])},function(a){return c.sp(b("LSUpdateTaskValue"),d[8],d[9],d[8])}]):c.resolve()}])},function(a){return c.resolve(e)}])}c=a;f["default"]=c}),66);
__d("LSUpdateThreadAuthorityAndMappingWithOTIDFromJID",["LSShimGetServerThreadKeyFromJIDV2.nop","LSUpdateThreadAuthorityAndMapping"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(e){return c.seq([function(e){return c.nop(b("LSShimGetServerThreadKeyFromJIDV2.nop"),a[0]).then(function(a){return a=a,d[0]=a[0],a})},function(e){return c.i64.neq(d[0],a[1])?d[1]=d[0]:d[1]=f,c.sp(b("LSUpdateThreadAuthorityAndMapping"),a[0],a[1],d[1])}])},function(a){return c.resolve(e)}])}c=a;f["default"]=c}),66);
__d("LSShimVerifyThreadExists.nop",["I64","LSAuthorityLevel","LSContactGender","LSContactIdType","LSContactType","LSContactViewerRelationship","LSContactWorkForeignEntityType","LSFactory","LSGroupParticipantJoinState","LSIntEnum","LSVec","LSVerifyContactRowExistsStoredProcedure","MAWMiActCreateThreadInActWithMiData","Promise","ReQL","WALoggerDeferred","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Occamadillo] MI thread insertion for fbid: "," with last activity timestamp: "," and last read timestamp: ",", read = ",""]);k=function(){return a};return a}function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){yield (j||(j=b("Promise"))).all(c("LSVec").toArray(f).map(function(b){return c("LSVerifyContactRowExistsStoredProcedure")(c("LSFactory")(a),{authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),blockedByViewerStatus:h.ofNumber(0),contactIdType:h.ofNumber(c("LSContactIdType").FBID),contactType:h.ofNumber(c("LSContactType").USER),contactViewerRelationship:h.ofNumber(c("LSContactViewerRelationship").UNKNOWN),gender:h.ofNumber(c("LSContactGender").UNKNOWN),id:b,isBlocked:!1,isMemorialized:!1,isSelf:!1,workForeignEntityType:h.ofNumber(c("LSContactWorkForeignEntityType").UNKNOWN)}).then(function(){return a.table("participants").put({authorityLevel:(h||(h=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC),contactId:b,deliveredWatermarkTimestampMs:(i||(i=d("I64"))).zero,groupParticipantJoinState:h.ofNumber(c("LSGroupParticipantJoinState").MEMBER),isModerator:!1,readActionTimestampMs:i.zero,readWatermarkTimestampMs:i.zero,threadKey:e})})}))});return m.apply(this,arguments)}function n(a,b,c){return a.table("mi_act_mapping_table").put({clientThreadPk:(i||(i=d("I64"))).neg(b),jid:c,serverThreadKey:b})}a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,j,m,o){b=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.table("mi_act_mapping_table")).getKeyRange(e)));b==null&&(yield n(a,e,f));c("promiseDone")(d("WALoggerDeferred").LOG(k(),(i||(i=d("I64"))).to_string(e),i.to_string(m),i.to_string(o),i.le(m,o)));yield l(a,e,g);c("promiseDone")(d("MAWMiActCreateThreadInActWithMiData").miActCreateThreadInActWithMiData(e,f,m,o,j));return});function e(b,c,d,e,f,g,h,i,j){return a.apply(this,arguments)}return e}();g["default"]=a}),98);
__d("LSVerifyHybridThreadExists",["LSShimVerifyThreadExists.nop","LSVerifyE2EEMetadataThreadExistsV2"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1];c.n;var d=[],e=[],f;return c.seq([function(g){return c.seq([function(e){return c.sp(b("LSVerifyE2EEMetadataThreadExistsV2"),a[2],a[0],c.i64.cast([0,60])).then(function(a){return a=a,d[0]=a[0],a})},function(b){return d[1]=c.i64.of_float(Date.now()),c.i64.neq(a[11],f)?c.seq([function(b){return c.ftr(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var g=b.done;b=b.value;return g?d[4]=!1:(e=b.item,d[7]=e.deviceId,c.i64.neq(d[7],f)?d[6]=c.i64.neq(d[7],a[11]):d[6]=!1,d[4]=d[6])})},function(a){return d[2]=d[4]}]):c.resolve(d[2]=!1)},function(e){return d[2]?d[3]=!0:d[3]=a[8],c.nop(b("LSShimVerifyThreadExists.nop"),a[0],a[1],a[3],a[4],a[5],a[6],a[7])},function(a){return e[0]=c.i64.cast([0,0])}])},function(a){return c.resolve(e)}])}c=a;f["default"]=c}),66);
__d("LSShimCopyAllParticipantNicknamesForThread",["gkx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,b=a[a.length-1];b.n;var d=[];return c("gkx")("4177")===!1?0:0,b.resolve(d)}b=a;g["default"]=b}),98);/*FB_PKG_DELIM*/
__d("LSCreateOpenToE2EEThreadLink",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.seq([function(c){return b.db.table(193).put({openThreadId:a[0],armadilloThreadId:a[1],showOpenMessageHistory:a[2],timestampMs:a[3]})},function(a){return b.resolve(c)}])}b=a;f["default"]=b}),66);
__d("LSMoveThreadToE2EECutoverFolder",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1];b.n;var c=[];return b.seq([function(c){return b.db.table(9).fetch([[[a[0]]]]).next().then(function(c,d){d=c.done;c=c.value;return d?0:(c.item,b.fe(b.db.table(9).fetch([[[a[0]]]]),function(a){var c=a.update;a.item;return c({folderName:"e2ee_cutover",parentThreadKey:b.i64.cast([-1,4294967279])})}))})},function(a){return b.resolve(c)}])}b=a;f["default"]=b}),66);
__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["LSDatabaseSingleton","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i=c("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function a(a,b,d,e,f,g,j,k,l,m,n,o){return i.load().then(function(a){c("promiseDone")((h||(h=c("LSDatabaseSingleton"))).then(function(c){return c.runInTransaction(function(c){return a.call(c,b,d,e,f,g,j,k,l,m,n,o)},"readwrite")}));return[[],[],!1]})}g.call=a}),98);
__d("LSBase64Decode.nop",["CryptoLogger","LSResult","Promise","base64-js"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){a=a.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=").replace("/,/","=");var b=4-a.length%4;if(b<4)for(var c=0;c<b;c++)a+="=";return a}function j(a){var b=d("CryptoLogger").CryptoLogger("base64decode");try{return a!=null?d("base64-js").toByteArray(i(a)).buffer:void 0}catch(c){if((c==null?void 0:c.message)==null)return;if(c instanceof Error)b.catching(c).mustfix(c.message);else{b.mustfix("Base64decode : empty error message for exception: %s, input string: %s",c.message,(b=a)!=null?b:"undefined")}}}a=function(a,d,e){return(h||(h=b("Promise"))).resolve(c("LSResult")(j(e)))};g["default"]=a}),98);
__d("LSSymmetricEncryptionCreateDecryptedData.bs",["CryptoLogger","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","Promise","RetUtil","SymmetricEncryptionPaddingUtils","globalCryptoSubtle"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("CryptoLogger").CryptoLogger("symmetric_encryption_create_decrypted_data");function a(a,e,f,g,j){if(j.byteLength<(d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes|0)){i.mustfix("cipher text is invalid");return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult())}a=new Uint8Array(j);var k=a.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes);e=new(d("HChaCha20").HChaCha20)();var l=a.slice(d("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer;j=e.hChaCha20Bytes(k.slice(0,d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,f);return c("globalCryptoSubtle").importKey("raw",j,"AES-GCM",!1,["decrypt"]).then(function(a){return c("globalCryptoSubtle").decrypt({additionalData:g,iv:new Uint8Array(k.slice(d("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:d("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},a,l)}).then(function(a){a=d("SymmetricEncryptionPaddingUtils").stripPadding(a);return d("RetUtil").getNullableRetResult(a!=null?a:(i.mustfix("Failed to strip padding for symmetric decryption"),void 0))})["catch"](function(a){d("CryptoLogger").captureError(i,a).mustfix("symmetric data decryption failed");return(h||(h=b("Promise"))).resolve(d("RetUtil").getNullableRetResult())})}g.call=a}),98);
__d("LSSymmetricEncryptionCreateDecryptedString.bs",["Base64Utils","CryptoLogger","LSResult","LSSymmetricEncryptionCreateDecryptedData.bs"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return c("LSResult")(a)}function a(a,b,c,e,f){var g=d("CryptoLogger").CryptoLogger("symmetric_encryption_create_decrypted_string");f=d("Base64Utils").toArrayBuffer(f);return d("LSSymmetricEncryptionCreateDecryptedData.bs").call(a,b,c,e,f).then(function(a){a=a[0];return a}).then(function(a){return a==null?h():h(new TextDecoder().decode(a))})["catch"](function(a){d("CryptoLogger").captureError(g,a).mustfix("symmetric string decryption failed");return h()})}g.call=a}),98);
__d("LSSymmetricEncryptionCreateDecryptedString.nop",["LSSymmetricEncryptionCreateDecryptedString.bs"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b,c,e,f){return d("LSSymmetricEncryptionCreateDecryptedString.bs").call(a,b,c,e,f)};g["default"]=a}),98);